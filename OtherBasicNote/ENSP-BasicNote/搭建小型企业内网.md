[TOC]

# 一、简介

- 这个例子是用eNSP模拟搭建一个小型企业的内网，涉及到的技术如下：
  - VLAN，隔离冲突域，方便管理，更加安全
  - DHCP，动态分配IP，方便管理
  - STP+VRRP，解决网关单点故障和链路冗余
  - OSPF，动态路由协议
  - ACL+NAT，数据包过滤和地址转换
- 本文章内容是根据该[视频]()制作的，建议观看视频，这里也感谢视频作者分享了这么好的学习资料
- 关于eNSP的安装就略过（如果自己实在找不到好的资源，可以私信我）

# 二、基础理论知识

- 这一小节就讲一下简介中涉及到的技术（部分）
- 我在本文中只会简单介绍这些技术，具体详细内容可以看我给出的链接
- 关于这些东西的配置，会在后面的例子中讲到（有些链接里有讲如何配置，有些没有）
- 本小节的内容可以先不看，直接看例子，在例子中碰到问题再返回观看来即可

## 1、VLAN

- VLAN：Virtual Local Area Network，虚拟局域网
- VLAN简单来讲就是在一个局域网（LAN）内再进行划分，划分的结果是两个或多个虚拟局域网（VLAN），同一个VLAN的主机可以正常相互通信（如根据ARP协议广播MAC地址请求），不同VLAN之不能直接通信（也就是说，即使两台主机通过一个交换机互联，但是被划分为属于两个不同VLAN后，两个主机的广播消息也不会传到对方那里去），VLAN的划分只需要在二层交换机（数据链路层）上设置即可
- 倘若不同VLAN之间想要通信，则需要加入路由的功能，可以使用路由器或者三层交换机（网络层）配置
- 建议观看[链接](https://baijiahao.baidu.com/s?id=1628398215665219628&wfr=spider&for=pc)的内容来了解VLAN，写得非常全

## 2、DHCP

- DHCP：Dynamic Host Configuration Protocol，动态主机配置协议
- 作用：动态分配IP地址
- 详细内容见[链接](https://xzj-dream.blog.csdn.net/article/details/104743179)

## 3、STP和VRRP

- STP：Spanning-Tree Protocol，生成树协议
- VRRP：Virtual Router Redundancy Protocol，虚拟路由器冗余协议

### （1）STP

- 作用：在局域网中消除环路，防止MAC地址表震荡而无法收敛
- 详细内容见[链接](https://www.jianshu.com/p/f4b7eaa6d697)，建议观看，写得非常全
- 如果想了解更多关于生成树的内容（比如说如何构造一颗生成树/最小重量生成树），可以查阅李建东老师的《通信网络基础》中第一章的1.4.4（图论基础）的内容

### （2）VRRP

- 作用：在多个真实的网关设备之间运行，形成一个“虚拟的网关”，从而实现多个真实网关之间的“冗余备份”，以及数据转发的负载均衡
- 详细内容见[链接](https://blog.51cto.com/13415528/2425405)

## 4、OSPF

- OSPF：Open Shortest Path First，开放最短路径优先
- 作用：动态路由协议，用于动态维护和更新路由表
- 详细内容见[链接](https://blog.51cto.com/13746824/2153847)
- 若想要深入了解这部分知识，建议查阅谢希仁老师的《计算机网络》中第四章的4.5节（互联网的路由选择协议），非常详细和全面

## 5、ACL和NAT

- ACL：Access Control List，访问控制列表
- NAT：Network Address Transform，网络地址转换

### （1）ACL

- 作用：ACL是应用在路由器接口的指令列表(规则)，这些指令列表告诉路由器，哪些数据包可以接受，哪些数据包需要拒绝
- 工作原理：ACL使用包过滤技术，在路由器上读取包头中的信息，如源地址，目标地址，源端口，目标端口等，根据预先定义好的规则，对包进行过滤，从而达到访问控制的目的
- 详细内容见[链接](https://blog.csdn.net/xiangyuenacha/article/details/83788513)
- 相关内容：[Linux下的iptables](https://xzj-dream.blog.csdn.net/article/details/104742821)

### （2）NAT

- 作用：简单来讲就是实现设备的内网地址（私有地址）和公网地址（公有地址）的互相转换
- 详细内容见[链接](https://blog.csdn.net/u013597671/article/details/74275852/)

## 6、其它涉及到的知识

- [二层交换机、三层交换机和路由器的基本工作原理和三者之间的主要区别](https://www.cnblogs.com/weifeng1463/p/7323929.html)

- [交换机三种端口模式Access、Hybrid和Trunk](http://www.qianjia.com/html/2018-06/06_294718.html)
- [交换机access和trunk](https://www.cnblogs.com/weiyikang/p/4945914.html)
- [交换机的Access口和Trunk口](https://www.cnblogs.com/boshen-hzb/p/9900814.html)
- [接入层、汇聚层和核心层交换机的特点](https://blog.csdn.net/Linux7985/article/details/78838132)

# 三、实例

## 1、流程

1. 配置VLAN：S1～S4
2. 配置DHCP：S1，S2，PC
3. 配置STP和VRRP：
   - STP：S1～S4
   - VRRP：S1，S2
4. 配置路由器：使用OSPF，配置S3，S4，R1，R2
5. 配置ACL和NAT：R1

## 2、设备型号

- 交换机（LSW）：S5700
- 线：auto
- 路由器：AR3260

## 3、网络拓扑



## 4、具体配置

### （1）配置VLAN

- LSW1和LSW2是接入层交换机，配置好VLAN和接口即可

  - LSW1的配置如下

  ```shell
  -------------------------------------------------------------------------------------
  sys  # 接入系统视图
  undo info-center enable  # 禁止信息提示，可简写为 un in en 
  												 # 启用信息提示的命令为 info-center enable
  sysname LSW1  # 给设备命名，可简写为 sys LSW1
  vlan 10  # 这两行是创建两个vlan
  vlan 20
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface e0/0/1  # 接入接口e0/0/1的配置，可简写为 int e0/0/1
  undo shutdown  # 启用接口，可简写为 un sh ,禁用接口为 shutdown ，简写为 sh
  port link-type access  # 设置该接口为access模式，可简写为 port link-t a
  port default vlan 10  # 绑定到vlan 10，可简写为 port de vlan 10
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface e0/0/2  
  undo shutdown  
  port link-type access  
  port default vlan 20  
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface e0/0/3    
  port link-type trunk  # 设置该接口为trunk模式，可简写为 port link-t t
  port trunk allow-pass vlan all  # 接口允许所有vlan通过，可简写为 port t allow vlan all
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface e0/0/4    
  port link-type trunk  
  port trunk allow-pass vlan all  
  quit
  -------------------------------------------------------------------------------------
  
  save
  ```

  - LSW2的配置如下

  ```shell
  -------------------------------------------------------------------------------------
  sys  
  undo info-center enable 
  sysname LSW2 
  vlan 30
  vlan 40
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface e0/0/1  
  undo shutdown  
  port link-type access  
  port default vlan 30
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface e0/0/2  
  undo shutdown  
  port link-type access  
  port default vlan 40  
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface e0/0/3    
  port link-type trunk  
  port trunk allow-pass vlan all  
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface e0/0/4    
  port link-type trunk  
  port trunk allow-pass vlan all  
  quit
  -------------------------------------------------------------------------------------
  
  save  # 保存配置
  ```

- LSW3和LSW4是核心层交换机

  - LSW3配置如下

  ```shell
  -------------------------------------------------------------------------------------
  sys
  undo info-center enable
  sysname LSW3
  vlan batch 10 20 30 40 50 60  # 另一种创建多个vlan的方法，有以下几种形式
  															# vlan batch 10 20 30 --> 创建10、20、30
  															# vlan batch 1 to 3 --> 创建1、2、3
  															# vlan batch 1 to 3 10 20 --> 创建1、2、3、10、20
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface g0/0/1
  port link-type trunk  
  port trunk allow-pass vlan all  
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface g0/0/2
  port link-type trunk  
  port trunk allow-pass vlan all  
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface g0/0/3
  port link-type trunk  
  port trunk allow-pass vlan all  
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface g0/0/4
  port link-type access  
  port default vlan 60 
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface g0/0/5
  port link-type access  
  port default vlan 50
  quit
  -------------------------------------------------------------------------------------
  
  # 接下来是配置LSW3的各个VLAN的IP地址（因为我们要使各个VLAN之间能通信，所以需要配置IP地址，以便能够使用路由功能，这也是LSW3和LSW4使用三层交换机的原因）
  -------------------------------------------------------------------------------------
  interface vlan 10  # 可简写为int v 10
  ip address 192.168.10.1 255.255.255.0  # 可简写为 ip add 192.168.10.1 24
  																			 # 此时LSW3就是该VLAN的网关
  interface vlan 20
  ip address 192.168.20.1 24
  interface vlan 30
  ip address 192.168.30.1 24
  interface vlan 40
  ip address 192.168.40.1 24
  interface vlan 50
  ip address 192.168.50.1 24
  interface vlan 60
  ip address 192.168.60.1 24
  quit
  -------------------------------------------------------------------------------------
  
  save
  ```

  - LSW4配置如下

  ```shell
  -------------------------------------------------------------------------------------
  sys
  undo info-center enable
  sysname LSW4
  vlan batch 10 20 30 40 50 60 
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface g0/0/1
  port link-type trunk  
  port trunk allow-pass vlan all  
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface g0/0/2
  port link-type trunk  
  port trunk allow-pass vlan all  
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface g0/0/3
  port link-type trunk  
  port trunk allow-pass vlan all  
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface g0/0/4
  port link-type access  
  port default vlan 70 
  quit
  -------------------------------------------------------------------------------------
  
  # 接下来是配置LSW4的各个VLAN的IP地址
  -------------------------------------------------------------------------------------
  interface vlan 10  
  ip address 192.168.10.2 24
  interface vlan 20
  ip address 192.168.20.2 24
  interface vlan 30
  ip address 192.168.30.2 24
  interface vlan 40
  ip address 192.168.40.2 24
  interface vlan 70
  ip address 192.168.70.2 24
  quit
  -------------------------------------------------------------------------------------
  
  save
  ```

### （2）配置DHCP

- LSW3的DHCP配置

  ```shell
  -------------------------------------------------------------------------------------
  sys
  dhcp enable  # 开启DHCP，可简写为 dhcp en
  ip pool vlan10  # 创建地址池
  gateway-list 192.168.10.254  # 设置虚拟网关地址
  network 192.168.10.0 mask 255.255.255.0  # 配置全局地址池下可分配的网段地址
  																			   # 可简写为 net 192.168.10.0 mask 255.255.255.0
  exclude-ip-address 192.168.10.1 192.168.10.127  
  # 配置不参与自动分配的IP地址为192.168.10.1-192.168.1.127
  # 可简写为 ex 192.168.10.1 192.168.10.127
  quit
  interface vlan 10
  dhcp select global  # 绑定接口
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  ip pool vlan20  
  gateway-list 192.168.20.254 
  network 192.168.20.0 mask 255.255.255.0  
  exclude-ip-address 192.168.20.1 192.168.20.127  
  quit
  interface vlan 20
  dhcp select global 
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  ip pool vlan30  
  gateway-list 192.168.30.254 
  network 192.168.30.0 mask 255.255.255.0  
  exclude-ip-address 192.168.30.1 192.168.30.127  
  quit
  interface vlan 30
  dhcp select global 
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  ip pool vlan40  
  gateway-list 192.168.40.254 
  network 192.168.40.0 mask 255.255.255.0  
  exclude-ip-address 192.168.40.1 192.168.40.127  
  quit
  interface vlan 40
  dhcp select global 
  quit
  quit
  -------------------------------------------------------------------------------------
  
  save
  ```

- LSW4的DHCP配置

  ```shell
  -------------------------------------------------------------------------------------
  sys
  dhcp enable  
  ip pool vlan10  
  gateway-list 192.168.10.254  
  network 192.168.10.0 mask 255.255.255.0  
  exclude-ip-address 192.168.10.128 192.168.10.253 
  quit
  interface vlan 10
  dhcp select global  
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  ip pool vlan20  
  gateway-list 192.168.20.254 
  network 192.168.20.0 mask 255.255.255.0  
  exclude-ip-address 192.168.20.128 192.168.20.253  
  quit
  interface vlan 20
  dhcp select global 
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  ip pool vlan30  
  gateway-list 192.168.30.254 
  network 192.168.30.0 mask 255.255.255.0  
  exclude-ip-address 192.168.30.128 192.168.30.253 
  quit
  interface vlan 30
  dhcp select global 
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  ip pool vlan40  
  gateway-list 192.168.40.254 
  network 192.168.40.0 mask 255.255.255.0  
  exclude-ip-address 192.168.40.128 192.168.40.253 
  quit
  interface vlan 40
  dhcp select global 
  quit
  quit
  -------------------------------------------------------------------------------------
  
  save
  ```

- 配置好LSW3和LSW4以后，配置PC1～PC4的DHCP

  - 选择静态—>应用
  - 运行PC的命令行，输入`ipconfig`，查看是否获取到IP地址

### （3）配置STP和VRRP

- 选择LSW3为根桥

- LSW1的配置如下

  ```shell
  sys
  stp mode stp  # 可简写为 stp m stp
  quit
  save
  ```

- LSW2的配置如下

  ```shell
  sys
  stp mode stp
  quit
  save
  ```

- LSW3（根桥，需配置VRRP）的配置如下

  ```shell
  -------------------------------------------------------------------------------------
  sys
  stp mode stp
  stp priority 0  # 设置优先级，可简写为 stp prio 0
  quit 
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface vlan 10
  vrrp vrid 10 virtual-ip 192.168.10.254  # 配置虚拟网关（光配置DHCP不同VLAN不能通信），主网关
  vrrp vrid 10 priority 120  # 配置优先级
  vrrp vrid 10 track interface g0/0/4 reduced 30   
  # 跟踪端口（g/0/0/4）不可用时，优先级降低为30，从而使backup成为master
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface vlan 20
  vrrp vrid 20 virtual-ip 192.168.20.254  
  vrrp vrid 20 priority 120
  vrrp vrid 20 track interface g0/0/4 reduced 30
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface vlan 30
  vrrp vrid 30 virtual-ip 192.168.30.254  
  quit
  interface vlan 40
  vrrp vrid 30 virtual-ip 192.168.40.254
  quit
  -------------------------------------------------------------------------------------
  
  save
  ```

- LSW4（需配置VRRP，为备份）的配置如下

  ```shell
  -------------------------------------------------------------------------------------
  sys
  stp mode stp
  stp priority 4096
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface vlan 10
  vrrp vrid 10 virtual-ip 192.168.10.254
  interface vlan 20
  vrrp vrid 20 virtual-ip 192.168.20.254
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface vlan 30
  vrrp vrid 30 virtual-ip 192.168.30.254
  vrrp vrid 30 priority 120
  vrrp 30 track interface g0/0/4 reduced 30
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface vlan 40
  vrrp vrid 40 virtual-ip 192.168.40.254
  vrrp vrid 30 priority 120
  vrrp 30 track interface g0/0/4 reduced 30
  quit
  -------------------------------------------------------------------------------------
  
  save
  ```

- 到这里，内网基本配置完成

### （4）配置路由

- LSW3和LSW4是三层交换机，所以也需要配置路由

- LSW3配置如下

  ```shell
  sys
  # 使用 display ip interface bridge 查看端口信息
  ospf 1  # 开启ospf进程协议1
  area 0.0.0.0  # 创建区域ID
  # 下面几步是指定运行OSPF协议的接口和接口所属的区域
  network 192.168.10.0 0.0.0.255
  network 192.168.20.0 0.0.0.255
  network 192.168.30.0 0.0.0.255
  network 192.168.40.0 0.0.0.255
  network 192.168.50.0 0.0.0.255
  network 192.168.60.0 0.0.0.255
  # 配置完成后可以使用 display ospf interface 命令检查OSPF接口通告是否正确。
  # 使用 display ip routing-table protocol ospf 命令可以查看OSPF路由表
  # 使用 display ospf peer 命令可以查看OSPF邻居状态。
  quit
  save
  ```

- LSW4配置如下

  ```shell
  sys
  ospf 1
  area 0.0.0.0
  network 192.168.10.0 0.0.0.255
  network 192.168.20.0 0.0.0.255
  network 192.168.30.0 0.0.0.255
  network 192.168.40.0 0.0.0.255
  network 192.168.50.0 0.0.0.255
  network 192.168.60.0 0.0.0.255
  quit
  save
  ```

- AR1的配置如下

  ```shell
  -------------------------------------------------------------------------------------
  sys
  undo info-center enable
  sysname AR1
  interface g0/0/0
  ip address 192.168.60.100 24
  interface g0/0/1
  ip address 192.168.70.100 24
  interface g0/0/2
  ip address 200.200.200.1 24
  quit
  # 可以使用命令 display ip interface bridge 查看各个端口IP地址
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  ospf 1
  area 0.0.0.0
  network 192.168.60.0 0.0.0.255
  network 192.168.70.0 0.0.0.255
  network 200.200.200.0 0.0.0.255
  quit
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  ip route-static 0.0.0.0 200.200.200.100  # 配置静态路由表，默认下一跳是200.200.200.100
  ospf 1
  default-route-advertise  # 向ospf区域注入默认路由
  quit
  quit
  -------------------------------------------------------------------------------------
  
  save
  ```

- AR2的配置如下

  ```shell
  sys
  undo info-center enable
  sysname AR2
  interface g0/0/0
  ip address 200.200.200.100 24
  interface g0/0/1
  ip address 200.200.201.1 24
  quit
  save
  ```

- 然后配置PC5的IP地址为200.200.201.100

### （5）配置ACL和NAT

- 目标是使vlan 10和vlan 30能够连到外网，使vlan50有一个公网IP

- AR1的配置如下

  ```shell
  -------------------------------------------------------------------------------------
  sys
  acl 2000  # 创建ACL，2000为ACL的编号，ACL分为标准ACL和扩展ACL，前者只检查数据包源IP地址
  								 
  rule 0 permit source 192.168.10.0 0.0.0.255  
  # ACL规则，语句含义如下
  # rule 0 --> 设定rule的ID，即表示第0条规则
  # permit --> 匹配规则的话则允许流量通过
  # source 192.168.10.0 0.0.0.255 --> 匹配的源地址为192.168.10.0～192.168.10.255
  # 0.0.0.255表示只匹配最后8位，如 source 192.168.10.1 0.0.0.0 表示精确源IP地址为192.168.10.1
  
  rule 5 permit source 192.168.30.0 0.0.0.255
  rule 10 permit source 192.168.50.0 0.0.0.255
  quit
  -------------------------------------------------------------------------------------
  
  -------------------------------------------------------------------------------------
  interface g0/0/2
  nat outbound 2000  # 绑定ACL，在g0/0/2接口下使用 nat outbound 命令将ACL 2000与地址池相关联，使得									 # ACL中匹配成功的地址可以使用地址池进行地址转换。（这里就是一个地址，不是地址池）
  nat static global 200.200.200.10 inside 192.168.50.100  # 配置静态nat转换
  quit
  quit
  -------------------------------------------------------------------------------------
  
  save
  ```
  
- 这两篇博客：[博客1](https://blog.csdn.net/hg515215563/article/details/103038433?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-3.nonecase&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-3.nonecase)和[博客2](https://www.cnblogs.com/arisskz6/p/12031976.html)讲ACL的配置讲得比较详细
  - 这篇[博客](https://www.cnblogs.com/swl0221/p/12028000.html)讲了nat的配置
  
- 到此就配置完成了